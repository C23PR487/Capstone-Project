git clone https://github.com/C23PR487/Capstone-Project.git

#build image
gcloud builds submit \
  --tag gcr.io/$GOOGLE_CLOUD_PROJECT/flask-server

#deploy ml model
gcloud run deploy flask-server \
  --image gcr.io/$GOOGLE_CLOUD_PROJECT/flask-server \
  --platform managed \
  --region asia-southeast2 \
  --memory=2Gi \
  --no-allow-unauthenticated \
  --max-instances=1

SERVICE_URL=$(gcloud beta run services describe flask-server --platform managed --region asia-southeast2 --format="value(status.url)")

gsutil mb gs://csv-bucket-test2

gsutil notification create -t new-doc -f json -e OBJECT_FINALIZE gs://csv-bucket-test2

gcloud iam service-accounts create pubsub-cloud-run-invoker --display-name "PubSub Cloud Run Invoker"

gcloud beta run services add-iam-policy-binding flask-server --member=serviceAccount:pubsub-cloud-run-invoker@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com --role=roles/run.invoker --platform managed --region asia-southeast2

gcloud projects list 
PROJECT_NUMBER=[project number]

gcloud projects add-iam-policy-binding $GOOGLE_CLOUD_PROJECT --member=serviceAccount:service-$PROJECT_NUMBER@gcp-sa-pubsub.iam.gserviceaccount.com --role=roles/iam.serviceAccountTokenCreator

gcloud beta pubsub subscriptions create predict-flask-sub --topic new-doc --push-endpoint=$SERVICE_URL --push-auth-service-account=pubsub-cloud-run-invoker@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com